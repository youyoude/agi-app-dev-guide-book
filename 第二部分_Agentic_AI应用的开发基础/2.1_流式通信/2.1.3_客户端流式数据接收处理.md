# 2.1.3 å®¢æˆ·ç«¯æµå¼æ•°æ®æ¥æ”¶ä¸å®æ—¶å†…å®¹æ¸²æŸ“

**å­¦ä¹ ç›®æ ‡ï¼š** å­¦ä¼šåœ¨å‰ç«¯å®ç°ç¨³å®šå¯é çš„æµå¼æ•°æ®æ¥æ”¶ï¼ŒæŒæ¡æµå¼UIæ›´æ–°çš„æœ€ä½³å®è·µ

åœ¨ä¸Šä¸€ç« æˆ‘ä»¬å­¦ä¹ äº†æµå¼é€šä¿¡æœåŠ¡ç«¯çš„æ„å»ºï¼Œæœ¬ç« å°†èšç„¦å®¢æˆ·ç«¯çš„æµå¼æ•°æ®æ¥æ”¶å¤„ç†ã€‚åœ¨AIåº”ç”¨åœºæ™¯ä¸­ï¼Œç”¨æˆ·æœŸæœ›çœ‹åˆ°æ¨¡å‹æ¨ç†è¿‡ç¨‹çš„å®æ—¶åé¦ˆï¼Œè€Œéç­‰å¾…æœ€ç»ˆç»“æœçš„"é»‘ç›’"ä½“éªŒâ€”â€”æµå¼é€šä¿¡æŠ€æœ¯æ­£æ˜¯è§£å†³è¿™ä¸€ç—›ç‚¹çš„å…³é”®ã€‚

æœ¬ç« å°†ä»¥JoyAgent-JDGenieé¡¹ç›®çš„å‰ç«¯å®ç°ä¸ºå®æˆ˜æ¡ˆä¾‹ï¼ŒåŸºäº **@microsoft/fetch-event-source + React + TypeScript** æŠ€æœ¯æ ˆï¼Œæ·±å…¥å‰–æå¦‚ä½•æ„å»º**ç¨³å®šå¯é ã€é«˜æ€§èƒ½**çš„æµå¼é€šä¿¡å®¢æˆ·ç«¯ç³»ç»Ÿï¼ŒåŒ…æ‹¬å…¶å››å±‚æ¶æ„è®¾è®¡å’Œå®æ—¶å†…å®¹æ¸²æŸ“æœºåˆ¶ã€‚

## ä¸€ã€å¼•è¨€

```typescript
// éæµå¼é€šä¿¡çš„å±€é™æ€§
const response = await fetch('/api/chat', {
  method: 'POST',
  body: JSON.stringify({message: "Hello AI"}),
});
const data = await response.json();
// âŒ ç”¨æˆ·éœ€è¦ç­‰å¾…å®Œæ•´å“åº”
// âŒ å¤§é‡æ•°æ®æ—¶å“åº”æ—¶é—´è¿‡é•¿

// æµå¼é€šä¿¡çš„ç”¨æˆ·ä½“éªŒçªç ´
import { fetchEventSource } from '@microsoft/fetch-event-source';
fetchEventSource('/api/chat-stream', {
  method: 'POST',
  body: JSON.stringify({message: "Hello AI"}),
  onmessage(event) {
    // âœ… å®æ—¶æ¥æ”¶AIçš„æ€è€ƒç‰‡æ®µ
    // âœ… é€å­—ç¬¦æ˜¾ç¤ºï¼Œæ‰“å­—æœºæ•ˆæœ
    // âœ… é•¿æ—¶é—´ä»»åŠ¡ä¸å†æ˜¯"é»‘ç›’"
    console.log('å®æ—¶æ¥æ”¶:', event.data);
  }
});
```

------

ä¸Šè¿°ä»£ç å¯¹æ¯”å±•ç¤ºäº†å‰ç«¯éæµå¼é€šä¿¡ä¸æµå¼é€šä¿¡çš„æ ¹æœ¬å·®å¼‚ã€‚åœ¨AIåº”ç”¨åœºæ™¯ä¸­ï¼Œç”¨æˆ·ä¸å†éœ€è¦ç›¯ç€è½¬åœˆçš„LoadingåŠ¨ç”»ï¼Œè€Œæ˜¯èƒ½å¤Ÿå®æ—¶è§‚å¯ŸAIçš„æ¨ç†è¿‡ç¨‹ã€ä»»åŠ¡æ‰§è¡Œè¿›åº¦å’Œä¸­é—´ç»“æœã€‚ä½†è¦å®ç°è¿™æ ·çš„ç”¨æˆ·ä½“éªŒï¼Œéœ€è¦æ„å»ºä¸€å¥—å®Œæ•´çš„å‰ç«¯æµå¼é€šä¿¡æ¶æ„ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†é€šè¿‡JoyAgent-JDGenieé¡¹ç›®å­¦ä¹ å¦‚ä½•åœ¨å®¢æˆ·ç«¯å®ç°è¿™æ ·çš„æµå¼äº¤äº’ç³»ç»Ÿã€‚

## äºŒã€JoyAgent-JDGenieå®¢æˆ·ç«¯æ ¸å¿ƒæŠ€æœ¯æ ˆåˆ†æ

### 2.1 fetch-event-sourceï¼šå¢å¼ºçš„SSEå®¢æˆ·ç«¯åº“

ä»€ä¹ˆæ˜¯fetch-event-sourceï¼Ÿ

`@microsoft/fetch-event-source`æ˜¯Microsoftå¼€æºçš„å¢å¼ºå‹SSEå®¢æˆ·ç«¯åº“ï¼Œå®ƒè§£å†³äº†æµè§ˆå™¨åŸç”ŸEventSource APIçš„æ ¸å¿ƒå±€é™æ€§ã€‚ç›¸æ¯”åŸç”Ÿå®ç°ï¼Œå®ƒæä¾›äº†æ›´å¼ºå¤§çš„é…ç½®èƒ½åŠ›å’Œæ›´å¯é çš„è¿æ¥ç®¡ç†ã€‚å…¶è¯ç”ŸèƒŒæ™¯ä¸åŸç”ŸEventSource APIçš„å·®å¼‚ï¼Œæˆ‘ä»¬å·²ç»åœ¨ç¬¬ä¸€ç« ä¸­è¯¦ç»†è®¨è®ºäº†ï¼Œåœ¨æ­¤ä¸å†èµ˜è¿°ã€‚

**fetch-event-sourceåœ¨æœ¬æ¡ˆä¾‹ä¸­çš„ä½œç”¨ï¼š**

- **å¢å¼ºHTTPèƒ½åŠ›**ï¼šæ”¯æŒPOSTè¯·æ±‚å’Œè‡ªå®šä¹‰è¯·æ±‚å¤´ï¼Œé€‚é…RESTful APIè®¾è®¡
- **è®¤è¯é›†æˆ**ï¼šé€šè¿‡credentialså‚æ•°æ”¯æŒCookieå’ŒTokenè®¤è¯
- **å¯é è¿æ¥**ï¼šå†…ç½®è‡ªåŠ¨é‡è¿æœºåˆ¶ï¼Œæä¾›ç¨³å®šçš„é•¿è¿æ¥ä¿éšœ
- **äº‹ä»¶é©±åŠ¨**ï¼šåŸºäºäº‹ä»¶å›è°ƒçš„è®¾è®¡ï¼Œä¸Reactç”Ÿå‘½å‘¨æœŸå®Œç¾é›†æˆ

### 2.2 TypeScriptï¼šç±»å‹å®‰å…¨çš„å¼€å‘ä½“éªŒ

TypeScriptä½œä¸ºé™æ€ç±»å‹è¯­è¨€ï¼Œåœ¨å¤æ‚çš„æµå¼é€šä¿¡åœºæ™¯ä¸­æä¾›äº†å…³é”®çš„ç±»å‹å®‰å…¨ä¿éšœã€‚ç‰¹åˆ«æ˜¯åœ¨å¤„ç†å¤šç§SSEæ¶ˆæ¯ç±»å‹æ—¶ï¼ŒTypeScriptèƒ½å¤Ÿåœ¨ç¼–è¯‘æœŸå‘ç°ç±»å‹é”™è¯¯ï¼Œå¤§å¹…æå‡å¼€å‘æ•ˆç‡ã€‚

**å¤æ‚æ¶ˆæ¯ç±»å‹çš„ç±»å‹å®šä¹‰ï¼š**

```typescript
// åŸºäºJoyAgent-JDGenieé¡¹ç›®çš„çœŸå®ç±»å‹å®šä¹‰

declare global {
  namespace MESSAGE {
    // åŸºç¡€ç±»å‹ï¼šè®¡åˆ’çŠ¶æ€æšä¸¾
    type PlanStatus = 'not_started' | 'in_progress' | 'completed'

    // å·¥å…·æ‰§è¡Œç»“æœç±»å‹
    type ToolResult = {
      toolName: string
      toolResult: string
      toolParam?: {
        query: string
      }
    }

    // æ¥å£æ•°æ®ï¼šæ¶ˆæ¯æ¡ç›®ç±»å‹
    type MsgItem = {
      logId: number
      name: string
      createTime: string
      sessionId: string
      requestId: string
      question: Question     // ç”¨æˆ·é—®é¢˜
      answer: Answer         // AIå›ç­”
      taskStatus: number
    }

    // æµå¼å“åº”æ¥å£ï¼šæ ¸å¿ƒSSEæ¶ˆæ¯ç»“æ„
    interface Answer {
      status: string         // ä¸šåŠ¡çŠ¶æ€
      finished: boolean      // æµå¼ä¼ è¾“å®Œæˆæ ‡å¿—
      resultMap: ResultMap   // æ ¸å¿ƒç»“æœæ•°æ®
      packageType: string    // "heartbeat" | "data"
      errorMsg: string       // é”™è¯¯ä¿¡æ¯
      useTokens: number      // æ¶ˆè€—tokenæ•°é‡
    }

    // å¤šæ™ºèƒ½ä½“æ•°æ®ç»“æ„
    interface MultiAgent {
      tasks: Task[][]        // äºŒç»´ä»»åŠ¡æ•°ç»„
      plan?: Plan           // æ‰§è¡Œè®¡åˆ’
      plan_thought?: string  // è®¡åˆ’æ€è€ƒè¿‡ç¨‹
    }
  }
}
```

**TypeScriptåœ¨æœ¬æ¡ˆä¾‹ä¸­çš„ä»·å€¼ï¼š**

- **æ¶ˆæ¯ç±»å‹çº¦æŸ**ï¼šç¡®ä¿SSEæ¶ˆæ¯å¤„ç†çš„ç±»å‹æ­£ç¡®æ€§
- **ç¼–è¯‘æœŸæ£€æŸ¥**ï¼šåœ¨å¼€å‘é˜¶æ®µå‘ç°æ½œåœ¨çš„ç±»å‹é”™è¯¯
- **æ™ºèƒ½æç¤º**ï¼šIDEæä¾›å®Œæ•´çš„ä»£ç è¡¥å…¨å’Œç±»å‹æç¤º
- **é‡æ„å®‰å…¨**ï¼šå¤§è§„æ¨¡ä»£ç é‡æ„æ—¶çš„ç±»å‹ä¿éšœ

### 2.3 React Hooksï¼šå“åº”å¼çŠ¶æ€ç®¡ç†

ä»€ä¹ˆæ˜¯React Hooksï¼Ÿ

React Hooksæ˜¯React 16.8å¼•å…¥çš„é©å‘½æ€§ç‰¹æ€§ï¼Œå®ƒè®©å‡½æ•°å¼ç»„ä»¶ä¹Ÿèƒ½å¤Ÿæ‹¥æœ‰çŠ¶æ€ç®¡ç†å’Œç”Ÿå‘½å‘¨æœŸèƒ½åŠ›ã€‚åœ¨æµå¼é€šä¿¡åœºæ™¯ä¸­ï¼ŒHooksæä¾›äº†ä¼˜é›…çš„çŠ¶æ€ç®¡ç†æ–¹æ¡ˆï¼Œèƒ½å¤Ÿé«˜æ•ˆå¤„ç†é¢‘ç¹çš„çŠ¶æ€æ›´æ–°å’Œç»„ä»¶é‡æ¸²æŸ“ï¼Œæ˜¯æ„å»ºç°ä»£Reactåº”ç”¨çš„æ ¸å¿ƒæŠ€æœ¯ã€‚

**Hooks vs ç±»ç»„ä»¶çš„æ ¸å¿ƒå·®å¼‚ï¼š**

```typescript
// âŒ ä¼ ç»Ÿç±»ç»„ä»¶ï¼šé€»è¾‘åˆ†æ•£ï¼Œthisç»‘å®šå¤æ‚
class ChatViewClass extends React.Component {
  state = { taskList: [], loading: false };
  
  componentDidMount() { this.initializeChat(); }
  componentWillUnmount() { this.cleanup(); }
  
  handleMessage = (data) => {
    this.setState({ taskList: newTaskList, loading: false });
  }
}

// âœ… Hookså‡½æ•°ç»„ä»¶ï¼šé€»è¾‘é›†ä¸­ï¼Œä»£ç ç®€æ´
const ChatView = () => {
  const [taskList, setTaskList] = useState([]);
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    initializeChat();
    return () => cleanup();  // æ¸…ç†é€»è¾‘å°±è¿‘æ”¾ç½®
  }, []);

  const handleMessage = useCallback((data) => {
    setTaskList(newTaskList);
    setLoading(false);
  }, []);
};
```

**æ ¸å¿ƒHooksåœ¨æµå¼é€šä¿¡ä¸­çš„åº”ç”¨ï¼š**

**1. useState - çŠ¶æ€ç®¡ç†**
```typescript
const [taskList, setTaskList] = useState<MESSAGE.Task[]>([]);
const [loading, setLoading] = useState(false);

// æ‰¹å¤„ç†ä¼˜åŒ–ï¼šReactè‡ªåŠ¨åˆå¹¶å¤šä¸ªçŠ¶æ€æ›´æ–°
const handleMessage = (data: MESSAGE.Answer) => {
  setTaskList(newTaskList);
  setLoading(false);
  setPlan(newPlan);
  // è‡ªåŠ¨åˆå¹¶ä¸º1æ¬¡é‡æ¸²æŸ“
};
```

**2. useRef - è·¨æ¸²æŸ“æ•°æ®å­˜å‚¨**
```typescript
const chatList = useRef<CHAT.ChatItem[]>([]);
const abortController = useRef<AbortController>();

// ä¸è§¦å‘é‡æ¸²æŸ“çš„æ•°æ®æ›´æ–°
const handleMessage = useCallback((data) => {
  chatList.current = [...chatList.current, newMessage];
}, []);
```

**3. useCallback & useMemo - æ€§èƒ½ä¼˜åŒ–**
```typescript
// ç¼“å­˜å‡½æ•°ï¼Œé¿å…å­ç»„ä»¶é‡æ¸²æŸ“
const sendMessage = useCallback((inputInfo) => {
  querySSE({ body: params, handleMessage });
}, [sessionId]);

// ç¼“å­˜è®¡ç®—ç»“æœ
const processedTasks = useMemo(() => 
  taskList.filter(task => task.visible)
, [taskList]);
```

**4. useEffect - å‰¯ä½œç”¨ç®¡ç†**
```typescript
// SSEè¿æ¥ç®¡ç†
useEffect(() => {
  const controller = new AbortController();
  
  querySSE({
    body: params,
    signal: controller.signal,
    handleMessage: (data) => handleMessage(data)
  });

  return () => controller.abort();  // è‡ªåŠ¨æ¸…ç†
}, [params]);
```

**React Hooksåœ¨æœ¬æ¡ˆä¾‹ä¸­çš„æ ¸å¿ƒä»·å€¼ï¼š**

- **ğŸ”„ å“åº”å¼çŠ¶æ€ç®¡ç†**ï¼šå®æ—¶å“åº”SSEæ¶ˆæ¯ï¼ŒåŠ¨æ€æ›´æ–°UIçŠ¶æ€
- **âš¡ æ€§èƒ½ä¼˜åŒ–**ï¼šé€šè¿‡useCallbackã€useMemoé¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“  
- **ğŸ›¡ï¸ èµ„æºç®¡ç†**ï¼šè‡ªåŠ¨å¤„ç†ç»„ä»¶ç”Ÿå‘½å‘¨æœŸï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
- **ğŸ§© é€»è¾‘å¤ç”¨**ï¼šé€šè¿‡è‡ªå®šä¹‰Hookå°è£…æµå¼é€šä¿¡é€»è¾‘
- **ğŸ’¡ ä»£ç ç®€åŒ–**ï¼šå‡½æ•°å¼ç¼–ç¨‹ï¼Œç›¸æ¯”ç±»ç»„ä»¶å‡å°‘50%ä»£ç é‡

### 2.4 TypeWriteræœºåˆ¶ï¼šæ‰“å­—æœºæ•ˆæœ

TypeWriterï¼ˆæ‰“å­—æœºæ•ˆæœï¼‰æ˜¯JoyAgent-JDGenieä¸­çš„æ ¸å¿ƒç”¨æˆ·ä½“éªŒç»„ä»¶ï¼Œå®ƒå°†æµå¼æ¥æ”¶çš„æ–‡æœ¬æ•°æ®è½¬æ¢ä¸ºé€å­—ç¬¦æ¸è¿›æ˜¾ç¤ºçš„æ•ˆæœï¼Œæ¨¡æ‹ŸçœŸäººè¾“å…¥ä½“éªŒã€‚

**TypeWriterCoreæ ¸å¿ƒå®ç°ï¼š**

```typescript
class TypeWriterCore {
  onConsume: (str: string) => void;
  queueList: string[] = [];        // å­—ç¬¦é˜Ÿåˆ—
  maxStepSeconds: number = 50;     // åŸºç¡€æ¸²æŸ“é—´éš”
  maxQueueNum: number = 2000;      // é˜Ÿåˆ—æœ€å¤§å®¹é‡
  timer: NodeJS.Timeout | null = null;

  // ğŸ§® åŠ¨æ€é€Ÿåº¦è°ƒæ•´ç®—æ³•
  dynamicSpeed(): number {
    const speedQueueNum = this.maxQueueNum / this.queueList.length;
    return Math.max(
      Math.min(speedQueueNum, this.maxStepSeconds), 
      10 // æœ€å°é—´éš”10msä¿è¯æµç•…åº¦
    );
  }

  // ğŸ“ é€å­—ç¬¦æ¸è¿›å¼æ¸²æŸ“
  next(): void {
    this.timer = setTimeout(() => {
      if (this.queueList.length > 0) {
        const char = this.queueList.shift();
        char && this.onConsume(char);  // é€å­—ç¬¦è¾“å‡º
        this.next();                   // é€’å½’è°ƒç”¨
      }
    }, this.dynamicSpeed());
  }

  // ğŸ“¦ æ·»åŠ æ–°å†…å®¹åˆ°æ¸²æŸ“é˜Ÿåˆ—
  add(text: string): void {
    const chars = text.split('');
    this.queueList.push(...chars);
    
    if (!this.timer) {
      this.next();  // å¯åŠ¨æ¸²æŸ“å¾ªç¯
    }
  }
}
```

**React Hooké›†æˆï¼š**

```typescript
export const useTypeWriter = ({text, options = {}}) => {
  const [typedText, setTypedText] = useState('');
  
  const typingCore = useMemo(
    () => new TypeWriterCore({
      onConsume: (str: string) => setTypedText(prev => prev + str),
      maxStepSeconds: options.speed || 50,
      maxQueueNum: options.queueSize || 2000,
    }),
    [options]
  );

  useEffect(() => {
    if (text) {
      typingCore.add(text);    // æ·»åŠ æ–°å†…å®¹
      typingCore.start();      // å¼€å§‹æ¸²æŸ“
    }
    
    return () => typingCore.onRendered();  // æ¸…ç†å®šæ—¶å™¨
  }, [text, typingCore]);

  return [typedText, typingCore];
};
```

**TypeWriteræœºåˆ¶åœ¨æœ¬æ¡ˆä¾‹ä¸­çš„ä»·å€¼ï¼š**

- **æ‰“å­—æœºæ•ˆæœ**ï¼šé€å­—ç¬¦æ˜¾ç¤ºæ¨¡æ‹ŸçœŸäººè¾“å…¥ï¼Œæå‡äº¤äº’è‡ªç„¶åº¦
- **æ€§èƒ½å¯æ§**ï¼šåŠ¨æ€è°ƒæ•´æ¸²æŸ“é€Ÿåº¦ï¼Œé€‚åº”ä¸åŒå†…å®¹é‡å’Œè®¾å¤‡æ€§èƒ½
- **é˜Ÿåˆ—ç®¡ç†**ï¼šæ™ºèƒ½ç¼“å†²åŒºç®¡ç†ï¼Œé¿å…å†…å­˜æ³„æ¼å’Œç•Œé¢å¡é¡¿
- **ç”¨æˆ·æ„ŸçŸ¥**ï¼šè®©ç”¨æˆ·æ„ŸçŸ¥AIæ­£åœ¨"æ€è€ƒ"å’Œ"è¾“å…¥"ï¼Œå‡å°‘ç­‰å¾…ç„¦è™‘

### 2.5 requestAnimationFrameï¼šé«˜æ€§èƒ½æ¸²æŸ“ä¼˜åŒ–

ä»€ä¹ˆæ˜¯requestAnimationFrameï¼Ÿ

requestAnimationFrameæ˜¯æµè§ˆå™¨æä¾›çš„ä¸“é—¨ç”¨äºåŠ¨ç”»ä¼˜åŒ–çš„APIï¼Œå®ƒèƒ½å¤Ÿå°†å›è°ƒå‡½æ•°çš„æ‰§è¡Œä¸æµè§ˆå™¨çš„åˆ·æ–°ç‡åŒæ­¥ï¼Œé€šå¸¸æ˜¯60fpsï¼ˆæ¯ç§’60å¸§ï¼‰ã€‚åœ¨æµå¼é€šä¿¡åœºæ™¯ä¸‹ï¼Œé¢‘ç¹çš„çŠ¶æ€æ›´æ–°å¾ˆå®¹æ˜“å¯¼è‡´æ€§èƒ½é—®é¢˜ï¼ŒrequestAnimationFrameæä¾›äº†ä¸€ç§ä¼˜é›…çš„è§£å†³æ–¹æ¡ˆã€‚

**åŸºç¡€å·¥ä½œåŸç†ï¼š**

æµè§ˆå™¨çš„æ¸²æŸ“æµæ°´çº¿éµå¾ªå›ºå®šçš„æ—¶é—´é—´éš”ï¼ˆé€šå¸¸16.67msä¸€æ¬¡ï¼‰ï¼Œæ¯ä¸€å¸§éƒ½ä¼šç»å†ï¼š
```
1. æ‰§è¡ŒJavaScript â†’ 2. æ ·å¼è®¡ç®— â†’ 3. å¸ƒå±€(é‡æ’) â†’ 4. ç»˜åˆ¶(é‡ç»˜) â†’ 5. åˆæˆæ˜¾ç¤º
```

```javascript
// âŒ ä¼ ç»Ÿåšæ³•ï¼šå¯èƒ½åœ¨ä»»æ„æ—¶åˆ»è§¦å‘æ¸²æŸ“
setTimeout(() => {
  updateUI();  // å¯èƒ½åœ¨æ¸²æŸ“å¸§ä¸­é€”æ‰§è¡Œï¼Œé€ æˆæµªè´¹
}, 0);

// âœ… requestAnimationFrameï¼šä¸æµè§ˆå™¨åˆ·æ–°ç‡åŒæ­¥
requestAnimationFrame(() => {
  updateUI();  // ä¿è¯åœ¨ä¸‹ä¸€ä¸ªæ¸²æŸ“å¸§å¼€å§‹æ—¶æ‰§è¡Œ
});
```

**ä¸ä¼ ç»Ÿå®šæ—¶å™¨çš„æ€§èƒ½å¯¹æ¯”ï¼š**

| å¯¹æ¯”ç»´åº¦ | setTimeout/setInterval | requestAnimationFrame |
|---------|----------------------|---------------------|
| **æ‰§è¡Œæ—¶æœº** | å›ºå®šæ—¶é—´é—´éš”ï¼Œä¸æ¸²æŸ“æ— å…³ | ä¸æµè§ˆå™¨åˆ·æ–°ç‡åŒæ­¥(60fps) |
| **æ€§èƒ½è¡¨ç°** | å¯èƒ½é€ æˆè¿‡åº¦æ¸²æŸ“æˆ–å¡é¡¿ | è‡ªåŠ¨ä¼˜åŒ–ï¼Œé¿å…æ— æ•ˆæ¸²æŸ“ |
| **é¡µé¢éšè—æ—¶** | ç»§ç»­æ‰§è¡Œï¼Œæµªè´¹èµ„æº | è‡ªåŠ¨æš‚åœï¼ŒèŠ‚çœCPU |
| **ç”µæ± ç»­èˆª** | æŒç»­æ¶ˆè€—ç”µé‡ | æ™ºèƒ½è°ƒèŠ‚ï¼Œå»¶é•¿ç»­èˆª |
| **åŠ¨ç”»æµç•…åº¦** | å®¹æ˜“å‡ºç°æ‰å¸§å’ŒæŠ–åŠ¨ | ä¿è¯60fpsçš„ä¸æ»‘ä½“éªŒ |

**æµå¼é€šä¿¡åœºæ™¯çš„æ€§èƒ½æŒ‘æˆ˜ï¼š**

```javascript
// é—®é¢˜åœºæ™¯ï¼šAIæ¶ˆæ¯é«˜é¢‘åˆ°è¾¾æ—¶çš„æ€§èƒ½ç“¶é¢ˆ
const handleMessage = (data: MESSAGE.Answer) => {
  // âŒ æ¯æ¬¡æ¶ˆæ¯éƒ½ç«‹å³è§¦å‘å¤šä¸ªçŠ¶æ€æ›´æ–°
  setTaskList(newTaskList);        // è§¦å‘ç¬¬1æ¬¡é‡æ¸²æŸ“
  updatePlan(newPlan);             // è§¦å‘ç¬¬2æ¬¡é‡æ¸²æŸ“  
  setLoading(false);               // è§¦å‘ç¬¬3æ¬¡é‡æ¸²æŸ“
  chatList.current = newChatList;  // è§¦å‘ç¬¬4æ¬¡é‡æ¸²æŸ“
  
  // ç»“æœï¼šåœ¨16.67mså†…å¯èƒ½è§¦å‘æ•°åæ¬¡é‡æ’é‡ç»˜ï¼Œå¯¼è‡´é¡µé¢å¡é¡¿
};

// âœ… ä¼˜åŒ–æ–¹æ¡ˆï¼šæ‰¹å¤„ç†åˆå¹¶æ›´æ–°
const handleMessage = (data: MESSAGE.Answer) => {
  requestAnimationFrame(() => {
    // æ‰€æœ‰çŠ¶æ€æ›´æ–°åœ¨åŒä¸€ä¸ªæ¸²æŸ“å¸§å†…å®Œæˆ
    setTaskList(newTaskList);
    updatePlan(newPlan);  
    setLoading(false);
    chatList.current = newChatList;
    
    // ç»“æœï¼šä¸€æ¬¡æ€§å®Œæˆæ‰€æœ‰æ›´æ–°ï¼Œå¤§å¹…æå‡æ€§èƒ½
  });
};
```

**æ™ºèƒ½æ‰¹å¤„ç†æœºåˆ¶ï¼š**

requestAnimationFrameèƒ½å¤Ÿè‡ªåŠ¨åˆå¹¶å¤šä¸ªæ›´æ–°è¯·æ±‚ï¼š

```typescript
// é«˜çº§ä¼˜åŒ–ï¼šé˜²é‡å¤è°ƒç”¨çš„æ‰¹å¤„ç†æœºåˆ¶
class RenderBatcher {
  private pendingUpdate = false;
  private updateQueue: (() => void)[] = [];

  scheduleUpdate(callback: () => void): void {
    this.updateQueue.push(callback);
    
    if (!this.pendingUpdate) {
      this.pendingUpdate = true;
      
      requestAnimationFrame(() => {
        // æ‰¹é‡æ‰§è¡Œæ‰€æœ‰å¾…æ›´æ–°çš„æ“ä½œ
        this.updateQueue.forEach(cb => cb());
        
        // æ¸…ç©ºé˜Ÿåˆ—ï¼Œå‡†å¤‡ä¸‹ä¸€è½®
        this.updateQueue = [];
        this.pendingUpdate = false;
      });
    }
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const batcher = new RenderBatcher();

// å³ä½¿å¿«é€Ÿè°ƒç”¨å¤šæ¬¡ï¼Œä¹Ÿåªä¼šåœ¨ä¸‹ä¸€å¸§æ‰§è¡Œä¸€æ¬¡
batcher.scheduleUpdate(() => setTaskList(newTasks));
batcher.scheduleUpdate(() => updatePlan(newPlan));
batcher.scheduleUpdate(() => setLoading(false));
```

**æ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒå®ç°ï¼š**

```typescript
const handleMessage = (data: MESSAGE.Answer) => {
  const { finished, resultMap, packageType } = data;
  
  // è¿‡æ»¤å¿ƒè·³æ¶ˆæ¯ï¼Œé¿å…æ— æ•ˆæ¸²æŸ“
  if (packageType !== "heartbeat") {
    // ğŸš€ å…³é”®ä¼˜åŒ–ï¼šä½¿ç”¨requestAnimationFrameæ‰¹å¤„ç†æ›´æ–°
    requestAnimationFrame(() => {
      if (resultMap?.eventData) {
        // 1. æ•°æ®åˆå¹¶å¤„ç†
        currentChat = combineData(resultMap.eventData, currentChat);
        
        // 2. æ‰¹é‡çŠ¶æ€æ›´æ–°
        const taskData = handleTaskData(currentChat, deepThink, currentChat.multiAgent);
        setTaskList(taskData.taskList);    // æ›´æ–°ä»»åŠ¡åˆ—è¡¨
        updatePlan(taskData.plan!);        // æ›´æ–°æ‰§è¡Œè®¡åˆ’
        openAction(taskData.taskList);     // æ§åˆ¶æ“ä½œé¢æ¿
        
        // 3. æµä¼ è¾“çŠ¶æ€ç®¡ç†
        if (finished) {
          currentChat.loading = false;
          setLoading(false);
        }
        
        // 4. è§¦å‘Reacté‡æ¸²æŸ“
        const newChatList = [...chatList.current];
        newChatList.splice(-1, 1, currentChat);
        chatList.current = newChatList;
      }
    });
    
    // 5. è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°å†…å®¹
    scrollToTop(chatRef.current!);
  }
};
```

**é¡µé¢å¯è§æ€§APIé›†æˆï¼š**

requestAnimationFrameä¸é¡µé¢å¯è§æ€§APIç»“åˆï¼Œå¯ä»¥å®ç°æ›´æ™ºèƒ½çš„æ€§èƒ½ä¼˜åŒ–ï¼š

```typescript
// é¡µé¢å¯è§æ€§ä¼˜åŒ–ï¼šé¿å…åå°æ ‡ç­¾é¡µçš„æ— æ•ˆæ¸²æŸ“
class SmartRenderer {
  private isPageVisible = true;
  private pendingUpdates: (() => void)[] = [];

  constructor() {
    // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–
    document.addEventListener('visibilitychange', () => {
      this.isPageVisible = !document.hidden;
      
      if (this.isPageVisible && this.pendingUpdates.length > 0) {
        // é¡µé¢é‡æ–°å¯è§æ—¶ï¼Œæ‰§è¡Œç§¯ç´¯çš„æ›´æ–°
        this.flushPendingUpdates();
      }
    });
  }

  scheduleUpdate(callback: () => void): void {
    if (this.isPageVisible) {
      // é¡µé¢å¯è§æ—¶æ­£å¸¸æ›´æ–°
      requestAnimationFrame(callback);
    } else {
      // é¡µé¢éšè—æ—¶ç§¯ç´¯æ›´æ–°
      this.pendingUpdates.push(callback);
    }
  }

  private flushPendingUpdates(): void {
    requestAnimationFrame(() => {
      this.pendingUpdates.forEach(update => update());
      this.pendingUpdates = [];
    });
  }
}
```

**æ€§èƒ½ç›‘æ§ä¸è°ƒè¯•ï¼š**

```typescript
// æ€§èƒ½ç›‘æ§ï¼šæµ‹é‡æ¸²æŸ“æ€§èƒ½
class PerformanceMonitor {
  private frameCount = 0;
  private lastTime = performance.now();

  measureFPS(): void {
    const measure = () => {
      this.frameCount++;
      const currentTime = performance.now();
      
      if (currentTime - this.lastTime >= 1000) {
        console.log(`FPS: ${this.frameCount}`);
        this.frameCount = 0;
        this.lastTime = currentTime;
      }
      
      requestAnimationFrame(measure);
    };
    
    requestAnimationFrame(measure);
  }

  measureUpdateCost(callback: () => void): void {
    const startTime = performance.now();
    
    requestAnimationFrame(() => {
      callback();
      
      requestAnimationFrame(() => {
        const endTime = performance.now();
        const duration = endTime - startTime;
        
        if (duration > 16.67) {  // è¶…è¿‡ä¸€å¸§æ—¶é—´
          console.warn(`æ…¢æ›´æ–°æ£€æµ‹: ${duration.toFixed(2)}ms`);
        }
      });
    });
  }
}

// åœ¨JoyAgent-JDGenieä¸­çš„ä½¿ç”¨
const monitor = new PerformanceMonitor();
monitor.measureFPS();  // å¼€å§‹FPSç›‘æ§

const handleMessage = (data: MESSAGE.Answer) => {
  monitor.measureUpdateCost(() => {
    requestAnimationFrame(() => {
      // æ‰¹é‡çŠ¶æ€æ›´æ–°é€»è¾‘
      currentChat = combineData(resultMap.eventData, currentChat);
      setTaskList(taskData.taskList);
      updatePlan(taskData.plan!);
    });
  });
};
```

**æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹ï¼š**

```typescript
// âœ… æœ€ä½³å®è·µ
class BestPracticeRenderer {
  private animationId: number | null = null;

  // 1. é¿å…åµŒå¥—è°ƒç”¨
  scheduleUpdate(callback: () => void): void {
    if (this.animationId !== null) {
      cancelAnimationFrame(this.animationId);  // å–æ¶ˆä¹‹å‰çš„è¯·æ±‚
    }
    
    this.animationId = requestAnimationFrame(() => {
      callback();
      this.animationId = null;  // é‡ç½®ID
    });
  }

  // 2. ç»„ä»¶å¸è½½æ—¶æ¸…ç†
  cleanup(): void {
    if (this.animationId !== null) {
      cancelAnimationFrame(this.animationId);
      this.animationId = null;
    }
  }

  // 3. æ¡ä»¶å¼æ›´æ–°
  conditionalUpdate(condition: boolean, callback: () => void): void {
    if (condition) {
      requestAnimationFrame(callback);
    }
  }
}

// Reactç»„ä»¶ä¸­çš„æ­£ç¡®ä½¿ç”¨
const ChatView = () => {
  const rendererRef = useRef(new BestPracticeRenderer());

  useEffect(() => {
    const renderer = rendererRef.current;
    
    return () => {
      renderer.cleanup();  // ç»„ä»¶å¸è½½æ—¶æ¸…ç†
    };
  }, []);

  const handleMessage = useCallback((data: MESSAGE.Answer) => {
    const renderer = rendererRef.current;
    
    renderer.conditionalUpdate(
      data.packageType !== "heartbeat",  // æ¡ä»¶æ£€æŸ¥
      () => {
        // æ‰¹é‡æ›´æ–°é€»è¾‘
        if (data.resultMap?.eventData) {
          currentChat = combineData(data.resultMap.eventData, currentChat);
          setTaskList(taskData.taskList);
          updatePlan(taskData.plan!);
        }
      }
    );
  }, []);
};
```

**æ¸²æŸ“ä¼˜åŒ–åœ¨æœ¬æ¡ˆä¾‹ä¸­çš„ç»¼åˆä»·å€¼ï¼š**

- **ğŸ¯ ç²¾ç¡®åŒæ­¥**ï¼šä¸æµè§ˆå™¨60fpsåˆ·æ–°ç‡å®Œç¾åŒæ­¥ï¼Œé¿å…æ‰å¸§ç°è±¡
- **âš¡ æ‰¹å¤„ç†æ›´æ–°**ï¼šå°†å¤šä¸ªçŠ¶æ€æ›´æ–°åˆå¹¶åˆ°ä¸€ä¸ªæ¸²æŸ“å¸§ä¸­ï¼Œå‡å°‘é‡æ’é‡ç»˜
- **ğŸ›¡ï¸ æ™ºèƒ½èŠ‚èƒ½**ï¼šé¡µé¢éšè—æ—¶è‡ªåŠ¨æš‚åœï¼Œæ˜¾è‘—é™ä½CPUå’Œç”µæ± æ¶ˆè€—
- **ğŸ“Š æ€§èƒ½å¯æ§**ï¼šé€šè¿‡ç›‘æ§å’Œè°ƒè¯•å·¥å…·ï¼Œå®æ—¶æŒæ§æ¸²æŸ“æ€§èƒ½çŠ¶å†µ
- **ğŸ”§ æ˜“äºç»´æŠ¤**ï¼šæ¸…æ™°çš„APIè®¾è®¡å’Œæœ€ä½³å®è·µï¼Œé™ä½ç»´æŠ¤å¤æ‚åº¦
- **ğŸ’¡ ç”¨æˆ·ä½“éªŒ**ï¼šä¿è¯60fpsçš„ä¸æ»‘ä½“éªŒï¼Œæä¾›ChatGPTçº§åˆ«çš„äº¤äº’æµç•…åº¦

## ä¸‰ã€JoyAgent-JDGenieå®¢æˆ·ç«¯åˆ†å±‚æ¶æ„é€Ÿè§ˆ

| å±‚çº§ | æ ¸å¿ƒæ¨¡å— | ä¸»è¦èŒè´£ | è¾“å…¥ç±»å‹ | è¾“å‡ºç±»å‹ |
|------|---------|----------|----------|----------|
| **ç¬¬1å±‚** | ChatViewç»„ä»¶<br/>(ä¸šåŠ¡å±‚) | ç”¨æˆ·äº¤äº’ç®¡ç†ã€ç»„ä»¶ç”Ÿå‘½å‘¨æœŸé›†æˆã€æµå¼ä½“éªŒä¼˜åŒ– | ç”¨æˆ·è¾“å…¥ã€æ–‡ä»¶ä¸Šä¼  | React JSXæ¸²æŸ“ |
| **ç¬¬2å±‚** | chat.tså·¥å…·å‡½æ•°<br/>(æ¶ˆæ¯å¤„ç†å±‚) | æ¶ˆæ¯ç±»å‹åˆ†å‘ã€å¢é‡æ•°æ®åˆå¹¶ã€å¤æ‚çŠ¶æ€ç®¡ç† | SSEåŸå§‹æ¶ˆæ¯ | æ ‡å‡†åŒ–ä¸šåŠ¡å¯¹è±¡ |
| **ç¬¬3å±‚** | querySSEå°è£…å‡½æ•°<br/>(å°è£…å±‚) | ç»Ÿä¸€SSEæ¥å£ã€é…ç½®ç®¡ç†ã€è¿æ¥ç”Ÿå‘½å‘¨æœŸæ§åˆ¶ | é…ç½®å‚æ•°ã€å›è°ƒå‡½æ•° | äº‹ä»¶å›è°ƒè§¦å‘ |
| **ç¬¬4å±‚** | fetch-event-source<br/>(ä¼ è¾“å±‚) | HTTPæµå¼åè®®å¤„ç†ã€è‡ªåŠ¨é‡è¿ã€ç½‘ç»œå¼‚å¸¸å¤„ç† | HTTPè¯·æ±‚é…ç½® | åŸå§‹SSEäº‹ä»¶æµ |

## å››ã€å®Œæ•´JoyAgent-JDGenieå‰ç«¯æµå¼é€šä¿¡æ—¶åºå›¾

ä¸‹å›¾å±•ç¤ºäº†ä»ç”¨æˆ·è¾“å…¥åˆ°å®æ—¶UIæ›´æ–°çš„å®Œæ•´å‰ç«¯æµå¼é€šä¿¡é“¾è·¯ã€‚æ•´ä¸ªæµç¨‹æ¶‰åŠ4ä¸ªæ ¸å¿ƒå±‚çº§ï¼šä¸šåŠ¡å±‚å¤„ç†ç”¨æˆ·äº¤äº’ â†’ å°è£…å±‚ç®¡ç†SSEè¿æ¥ â†’ ä¼ è¾“å±‚å»ºç«‹HTTPæµå¼è¿æ¥ â†’ æ¶ˆæ¯å¤„ç†å±‚è½¬æ¢æ•°æ®æ ¼å¼ã€‚æµå¼å“åº”æ²¿ç›¸åæ–¹å‘é€å±‚ä¼ é€’ï¼Œæœ€ç»ˆå®ç°å®æ—¶UIæ›´æ–°ã€‚

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Business as ä¸šåŠ¡å±‚<br>(ChatViewç»„ä»¶)
    participant Processor as æ¶ˆæ¯å¤„ç†å±‚<br>(chat.ts)
    participant Wrapper as å°è£…å±‚<br>(querySSE)
    participant Transport as ä¼ è¾“å±‚<br>(fetch-event-source)
    participant Server as åç«¯æœåŠ¡

    Note over User, Server: JoyAgent-JDGenieå‰ç«¯å››å±‚æ¶æ„æµå¼é€šä¿¡

    %% 1. ç”¨æˆ·äº¤äº’ä¸ä¸šåŠ¡å±‚å¤„ç†
    User->>+Business: è¾“å…¥æ¶ˆæ¯å¹¶å‘é€
    Business->>Business: ä¹è§‚æ›´æ–°UIçŠ¶æ€<br>setLoading(true)
    
    %% 2. è·¨å±‚è°ƒç”¨é“¾
    Business->>+Wrapper: querySSE(config)
    Note right of Business: ä¼ é€’é…ç½®ï¼š<br>body, handleMessage,<br>handleError, handleClose
    Wrapper->>+Transport: fetchEventSource(url, options)
    Transport->>+Server: å»ºç«‹SSEè¿æ¥<br>POSTè¯·æ±‚

    %% 3. æµå¼æ¶ˆæ¯å¤„ç†å¾ªç¯
    loop æµå¼æ¶ˆæ¯æ¥æ”¶ä¸å¤„ç†
        Server-->>Transport: SSEæ¶ˆæ¯æµ
        Note right of Server: æ¶ˆæ¯ç±»å‹ï¼š<br>plan_thought, plan,<br>task, contentç­‰
        
        Transport->>Transport: è‡ªåŠ¨JSONè§£æ
        Transport-->>Wrapper: onmessage(event)
        
        Wrapper->>Wrapper: æ•°æ®é¢„å¤„ç†ä¸éªŒè¯
        Wrapper-->>Business: handleMessage(data)
        
        %% ä¸šåŠ¡å±‚çš„æ ¸å¿ƒå¤„ç†é€»è¾‘
        Business->>Business: è¿‡æ»¤å¿ƒè·³æ¶ˆæ¯
        Business->>+Processor: combineData(eventData, currentChat)
        
        Note over Processor: æ¶ˆæ¯åˆ†å‘å¤„ç†ï¼š<br>â€¢ handlePlanThoughtMessage<br>â€¢ handleTaskMessage<br>â€¢ handleContentMessage
        
        Processor-->>Business: è¿”å›å¤„ç†åçš„çŠ¶æ€
        
        %% æ€§èƒ½ä¼˜åŒ–çš„æ‰¹å¤„ç†æ›´æ–°
        Business->>Business: æ‰¹é‡çŠ¶æ€æ›´æ–°<br>(requestAnimationFrameä¼˜åŒ–)
        
        Business-->>User: å®æ—¶UIæ›´æ–°<br>æ‰¹é‡çŠ¶æ€æ›´æ–°
    end

    %% 4. æµä¼ è¾“å®Œæˆ
    Server->>Transport: å‘é€å®Œæˆæ ‡å¿—
    Transport-->>Wrapper: æœ€ç»ˆæ¶ˆæ¯
    Wrapper-->>Business: finished: true
    Business->>Business: æ¸…ç†åŠ è½½çŠ¶æ€<br>setLoading(false)
    Business-->>User: æ˜¾ç¤ºæœ€ç»ˆç»“æœ

    %% 5. è¿æ¥å…³é—­ä¸æ¸…ç†
    Server->>Transport: å…³é—­SSEè¿æ¥
    Transport->>Wrapper: onclose()
    Wrapper->>Business: handleClose()
    Business->>Business: èµ„æºæ¸…ç†

    %% 6. å¼‚å¸¸å¤„ç†æµç¨‹
    alt ç½‘ç»œæˆ–è§£æå¼‚å¸¸
        Transport->>Wrapper: onerror(error)
        Wrapper->>Business: handleError(error)
        Business-->>User: æ˜¾ç¤ºé”™è¯¯æç¤º
        Business->>Business: æ¢å¤UIçŠ¶æ€
    end
```

## äº”ã€å®¢æˆ·ç«¯åˆ†å±‚è¯¦è§£

æœ¬èŠ‚é€šè¿‡ç®€åŒ–ä»£ç ç‰‡æ®µï¼Œæ·±å…¥åˆ†æå‰ç«¯æµå¼é€šä¿¡çš„4å±‚æ¶æ„å®ç°æœºåˆ¶ï¼š

### 5.1 ç¬¬1å±‚ï¼šä¸šåŠ¡å±‚ç»„ä»¶ (ChatView)

```typescript
// ui/src/components/ChatView/index.tsx
const ChatView: GenieType.FC<Props> = (props) => {
  // ============ çŠ¶æ€ç®¡ç† ============
  const [taskList, setTaskList] = useState<MESSAGE.Task[]>([]);  // ä»»åŠ¡åˆ—è¡¨çŠ¶æ€
  const [loading, setLoading] = useState(false);                 // åŠ è½½çŠ¶æ€
  const chatList = useRef<CHAT.ChatItem[]>([]);                 // èŠå¤©è®°å½•ï¼ˆä¸è§¦å‘é‡æ¸²æŸ“ï¼‰

  const sendMessage = useMemoizedFn((inputInfo: CHAT.TInputInfo) => {
    // ============ 1. å‚æ•°å‡†å¤‡ ============
    const {message, deepThink, outputStyle} = inputInfo;
    const requestId = getUniqId();                               // ç”Ÿæˆå”¯ä¸€è¯·æ±‚ID
    let currentChat = combineCurrentChat(inputInfo, sessionId, requestId);
    
    // ============ 2. ä¹è§‚æ›´æ–°UI ============
    // ç«‹å³æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
    chatList.current = [...chatList.current, currentChat];
    if (!chatTitle) {
      setChatTitle(message!);                                    // è®¾ç½®èŠå¤©æ ‡é¢˜
    }
    setLoading(true);                                           // æ˜¾ç¤ºåŠ è½½çŠ¶æ€

    // ============ 3. æ„å»ºè¯·æ±‚å‚æ•° ============
    const params = {
      sessionId: sessionId,
      requestId: requestId,
      query: message,
      deepThink: deepThink ? 1 : 0,                             // æ·±åº¦æ€è€ƒæ¨¡å¼
      outputStyle                                               // è¾“å‡ºé£æ ¼
    };

    /**
     * ============ 4. æµå¼æ¶ˆæ¯å¤„ç†æ ¸å¿ƒé€»è¾‘ ============
     * å¤„ç†æœåŠ¡ç«¯æ¨é€çš„å®æ—¶æ¶ˆæ¯ï¼Œå®ç°æµå¼UIæ›´æ–°
     */
    const handleMessage = (data: MESSAGE.Answer) => {
      const { finished, resultMap, packageType, status } = data;
      
      // ä¸šåŠ¡å¼‚å¸¸å¤„ç†ï¼šé…é¢ç”¨å°½ã€æƒé™ä¸è¶³ç­‰
      if (status === "tokenUseUp") {
        modal.info({
          title: 'æ‚¨çš„è¯•ç”¨æ¬¡æ•°å·²ç”¨å°½',
          content: 'å¦‚éœ€é¢å¤–ç”³è¯·ï¼Œè¯·è”ç³»ç›¸å…³äººå‘˜',
        });
        currentChat.loading = false;
        setLoading(false);
        return;  // ç»ˆæ­¢å¤„ç†
      }

      // è¿‡æ»¤å¿ƒè·³æ¶ˆæ¯ï¼Œåªå¤„ç†çœŸå®æ•°æ®
      if (packageType !== "heartbeat") {
        // ğŸš€ æ€§èƒ½å…³é”®ï¼šä½¿ç”¨requestAnimationFrameæ‰¹å¤„ç†æ›´æ–°ï¼Œé¿å…é¢‘ç¹é‡æ’é‡ç»˜
        requestAnimationFrame(() => {
          if (resultMap?.eventData) {
            // æ•°æ®åˆå¹¶ï¼šå°†æ–°æ¶ˆæ¯ä¸ç°æœ‰èŠå¤©çŠ¶æ€åˆå¹¶
            currentChat = combineData(resultMap.eventData || {}, currentChat);
            const taskData = handleTaskData(
              currentChat,
              deepThink,
              currentChat.multiAgent
            );
            
            // æ‰¹é‡çŠ¶æ€æ›´æ–°ï¼šä¸€æ¬¡æ€§æ›´æ–°æ‰€æœ‰ç›¸å…³çŠ¶æ€
            setTaskList(taskData.taskList);                     // æ›´æ–°ä»»åŠ¡åˆ—è¡¨
            updatePlan(taskData.plan!);                         // æ›´æ–°æ‰§è¡Œè®¡åˆ’
            openAction(taskData.taskList);                      // æ§åˆ¶æ“ä½œé¢æ¿æ˜¾ç¤º
            
            // æµå¼ä¼ è¾“å®Œæˆå¤„ç†
            if (finished) {
              currentChat.loading = false;
              setLoading(false);                                // éšè—åŠ è½½çŠ¶æ€
            }
            
            // Reacté‡æ¸²æŸ“è§¦å‘ï¼šæ›´æ–°èŠå¤©è®°å½•å¼•ç”¨
            const newChatList = [...chatList.current];
            newChatList.splice(newChatList.length - 1, 1, currentChat);
            chatList.current = newChatList;
          }
        });
        
        // ç”¨æˆ·ä½“éªŒä¼˜åŒ–ï¼šè‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
        scrollToTop(chatRef.current!);
      }
    };

    // ============ 5. é”™è¯¯å¤„ç† ============
    const handleError = (error: unknown) => {
      console.error('SSEè¿æ¥é”™è¯¯:', error);
      setLoading(false);                                        // æ¢å¤UIçŠ¶æ€
    };

    // ============ 6. è¿æ¥å…³é—­å¤„ç† ============
    const handleClose = () => {
      console.log('SSEè¿æ¥å·²å…³é—­');
    };

    // ============ 7. å‘èµ·æµå¼é€šä¿¡è¿æ¥ ============
    querySSE({
      body: params,                                             // è¯·æ±‚å‚æ•°
      handleMessage,                                            // æ¶ˆæ¯å¤„ç†å›è°ƒ
      handleError,                                              // é”™è¯¯å¤„ç†å›è°ƒ
      handleClose,                                              // è¿æ¥å…³é—­å›è°ƒ
    });
  });

  // ============ UIæ¸²æŸ“ ============
  return (
    <div className="h-full w-full flex justify-center">
      {/* æ¶ˆæ¯è¾“å…¥ç»„ä»¶ */}
      <GeneralInput send={sendMessage} />
      {/* æ“ä½œé¢æ¿ç»„ä»¶ */}
      <ActionView 
        taskList={taskList}      // ä¼ é€’ä»»åŠ¡åˆ—è¡¨
        plan={plan}             // ä¼ é€’æ‰§è¡Œè®¡åˆ’
        loading={loading}       // ä¼ é€’åŠ è½½çŠ¶æ€
      />
    </div>
  );
};
```

**ç¬¬1å±‚çš„æ ¸å¿ƒèŒè´£ï¼š**
- **ç”¨æˆ·äº¤äº’ç®¡ç†**ï¼šå¤„ç†ç”¨æˆ·è¾“å…¥ã€æ–‡ä»¶ä¸Šä¼ ã€å‚æ•°é…ç½®ç­‰å‰ç«¯äº¤äº’
- **ç»„ä»¶ç”Ÿå‘½å‘¨æœŸé›†æˆ**ï¼šå°†æµå¼é€šä¿¡ä¸Reactç»„ä»¶ç”Ÿå‘½å‘¨æœŸæ·±åº¦èåˆ
- **çŠ¶æ€åè°ƒä¸­å¿ƒ**ï¼šç»Ÿä¸€ç®¡ç†loadingã€taskListã€planç­‰å¤šç§UIçŠ¶æ€
- **æµå¼ä½“éªŒä¼˜åŒ–**ï¼šä¹è§‚æ›´æ–°ã€æ‰¹é‡æ¸²æŸ“ã€è‡ªåŠ¨æ»šåŠ¨ç­‰ç”¨æˆ·ä½“éªŒä¼˜åŒ–
- **ä¸šåŠ¡æµç¨‹ç¼–æ’**ï¼šåè°ƒæ¶ˆæ¯å‘é€ã€çŠ¶æ€æ›´æ–°ã€é”™è¯¯å¤„ç†çš„å®Œæ•´ä¸šåŠ¡æµç¨‹

### 5.2 ç¬¬2å±‚ï¼šæ¶ˆæ¯å¤„ç†å±‚ (chat.ts)

```typescript
// ui/src/utils/chat.ts

/**
 * æ ¸å¿ƒæ¶ˆæ¯åˆ†å‘é€»è¾‘
 * æ”¯æŒå¤šç§æ¶ˆæ¯ç±»å‹çš„å¢é‡å¼å¤„ç†
 */
export const combineData = (
  eventData: MESSAGE.EventData,
  currentChat: CHAT.ChatItem
) => {
  switch (eventData.messageType) {
    case "plan": {
      handlePlanMessage(eventData, currentChat);
      break;
    }
    case "plan_thought": {
      handlePlanThoughtMessage(eventData, currentChat);
      break;
    }
    case "task": {
      handleTaskMessage(eventData, currentChat);
      break;
    }
    default:
      break;
  }
  return currentChat;
};

/**
 * è®¡åˆ’æ€è€ƒç±»å‹çš„å¢é‡å¼æ›´æ–°å¤„ç†
 * å®ç°æ–‡æœ¬æµå¼è¿½åŠ çš„æ ¸å¿ƒé€»è¾‘
 */
function handlePlanThoughtMessage(
  eventData: MESSAGE.EventData,
  currentChat: CHAT.ChatItem
) {
  if (!currentChat.multiAgent.plan_thought) {
    currentChat.multiAgent.plan_thought = "";
  }
  
  if (eventData.resultMap.isFinal) {
    // æœ€ç»ˆæ¶ˆæ¯ï¼šç›´æ¥æ›¿æ¢
    currentChat.multiAgent.plan_thought = eventData.resultMap.planThought;
  } else {
    // å¢é‡æ¶ˆæ¯ï¼šè¿½åŠ å†…å®¹
    currentChat.multiAgent.plan_thought += eventData.resultMap.planThought;
  }
}

/**
 * ä»»åŠ¡æ¶ˆæ¯çš„å¤æ‚çŠ¶æ€ç®¡ç†
 * å¤„ç†åµŒå¥—çš„ä»»åŠ¡-å·¥å…·å±‚çº§ç»“æ„
 */
function handleTaskMessage(
  eventData: MESSAGE.EventData,
  currentChat: CHAT.ChatItem
) {
  if (!currentChat.multiAgent.tasks) {
    currentChat.multiAgent.tasks = [];
  }
  
  const taskIndex = findTaskIndex(currentChat.multiAgent.tasks, eventData.taskId);
  const toolIndex = findToolIndex(currentChat.multiAgent.tasks[taskIndex], eventData.messageId);
  
  if (taskIndex === -1) {
    // åˆ›å»ºæ–°ä»»åŠ¡
    currentChat.multiAgent.tasks.push([createNewTask(eventData)]);
  } else if (toolIndex === -1) {
    // ä¸ºç°æœ‰ä»»åŠ¡æ·»åŠ æ–°å·¥å…·
    currentChat.multiAgent.tasks[taskIndex].push(createNewTask(eventData));
  } else {
    // æ›´æ–°ç°æœ‰å·¥å…·çŠ¶æ€
    updateExistingTool(currentChat, taskIndex, toolIndex, eventData.resultMap);
  }
}

/**
 * å·¥å…·æ€è€ƒæ¶ˆæ¯çš„æµå¼æ›´æ–°
 * æ”¯æŒå¢é‡å’Œå®Œæ•´æ›¿æ¢ä¸¤ç§æ¨¡å¼
 */
function updateToolThought(
  currentChat: CHAT.ChatItem, 
  taskIndex: number, 
  toolIndex: number, 
  eventData: MESSAGE.EventData
) {
  const { toolThought, isFinal } = eventData.resultMap;
  const tool = currentChat.multiAgent.tasks[taskIndex][toolIndex];
  
  if (isFinal) {
    // æœ€ç»ˆæ¶ˆæ¯ï¼šå®Œæ•´æ›¿æ¢
    tool.toolThought = toolThought;
  } else {
    // å¢é‡æ¶ˆæ¯ï¼šè¿½åŠ æ›´æ–°
    tool.toolThought = (tool.toolThought || '') + toolThought;
  }
}
```

**ç¬¬2å±‚çš„æ ¸å¿ƒèŒè´£ï¼š**
- **æ™ºèƒ½æ¶ˆæ¯åˆ†å‘**ï¼šæ ¹æ®messageTypeå°†ä¸åŒç±»å‹çš„SSEæ¶ˆæ¯è·¯ç”±åˆ°å¯¹åº”å¤„ç†å‡½æ•°
- **å¢é‡æ•°æ®åˆå¹¶**ï¼šå¤„ç†æµå¼æ•°æ®çš„å¢é‡æ›´æ–°ï¼Œé€šè¿‡isFinalæ ‡å¿—åŒºåˆ†å¢é‡å’Œå®Œæ•´æ•°æ®
- **å¤æ‚çŠ¶æ€ç®¡ç†**ï¼šç®¡ç†å¤šå±‚çº§åµŒå¥—çš„ä»»åŠ¡-å·¥å…·æ•°æ®ç»“æ„
- **æ•°æ®æ ¼å¼æ ‡å‡†åŒ–**ï¼šå°†æœåŠ¡ç«¯åŸå§‹æ¶ˆæ¯æ ¼å¼è½¬æ¢ä¸ºå‰ç«¯ç»„ä»¶å¯ç”¨çš„æ ‡å‡†åŒ–ç»“æ„
- **ä¸šåŠ¡é€»è¾‘é›†ä¸­åŒ–**ï¼šé›†ä¸­å¤„ç†AIæ€è€ƒã€æ‰§è¡Œè®¡åˆ’ã€å·¥å…·è°ƒç”¨ç­‰æ ¸å¿ƒä¸šåŠ¡é€»è¾‘

### 5.3 ç¬¬3å±‚ï¼šå°è£…å±‚ (querySSE)

```typescript
// ui/src/utils/querySSE.ts
import { fetchEventSource, EventSourceMessage } from '@microsoft/fetch-event-source';

const customHost = SERVICE_BASE_URL || '';
const DEFAULT_SSE_URL = `${customHost}/web/api/v1/gpt/queryAgentStreamIncr`;

const SSE_HEADERS = {
  'Content-Type': 'application/json',
  'Cache-Control': 'no-cache',
  'Connection': 'keep-alive',
  'Accept': 'text/event-stream',
};

interface SSEConfig {
  body: any;
  handleMessage: (data: any) => void;
  handleError: (error: Error) => void;
  handleClose: () => void;
}

/**
 * åˆ›å»ºæœåŠ¡å™¨å‘é€äº‹ä»¶ï¼ˆSSEï¼‰è¿æ¥
 * æ ¸å¿ƒè®¾è®¡ç†å¿µï¼šå°è£…å¤æ‚æ€§ï¼Œæš´éœ²ç®€æ´æ¥å£
 */
export default (config: SSEConfig, url: string = DEFAULT_SSE_URL): void => {
  const { body = null, handleMessage, handleError, handleClose } = config;

  fetchEventSource(url, {
    method: 'POST',
    credentials: 'include',  // æºå¸¦è®¤è¯ä¿¡æ¯
    headers: SSE_HEADERS,
    body: JSON.stringify(body),
    openWhenHidden: true,    // é¡µé¢ä¸å¯è§æ—¶ä¿æŒè¿æ¥
    
    onmessage(event: EventSourceMessage) {
      if (event.data) {
        try {
          const parsedData = JSON.parse(event.data);
          handleMessage(parsedData);
        } catch (error) {
          console.error('Error parsing SSE message:', error);
          handleError(new Error('Failed to parse SSE message'));
        }
      }
    },
    
    onerror(error: Error) {
      console.error('SSE error:', error);
      handleError(error);
    },
    
    onclose() {
      console.log('SSE connection closed');
      handleClose();
    }
  });
};
```

**ç¬¬3å±‚çš„æ ¸å¿ƒèŒè´£ï¼š**
- **ç»Ÿä¸€é€šä¿¡æ¥å£**ï¼šä¸ºä¸Šå±‚ä¸šåŠ¡æä¾›æ ‡å‡†åŒ–çš„SSEè°ƒç”¨æ¥å£
- **é…ç½®ç®¡ç†ä¸­å¿ƒ**ï¼šé›†ä¸­ç®¡ç†SSEè¿æ¥çš„è¯·æ±‚å¤´ã€è®¤è¯ä¿¡æ¯å’Œç½‘ç»œé…ç½®
- **è¿æ¥ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼šå¤„ç†è¿æ¥å»ºç«‹ã€æ¶ˆæ¯æ¥æ”¶ã€é”™è¯¯å¤„ç†å’Œè¿æ¥å…³é—­
- **æ•°æ®é¢„å¤„ç†**ï¼šå¯¹æœåŠ¡ç«¯åŸå§‹SSEæ¶ˆæ¯è¿›è¡ŒJSONè§£æå’Œåˆæ­¥éªŒè¯
- **é”™è¯¯è¾¹ç•Œé˜²æŠ¤**ï¼šåœ¨ä¼ è¾“å±‚æ•è·å’Œå¤„ç†ç½‘ç»œå¼‚å¸¸ï¼Œé¿å…å½±å“ä¸Šå±‚ä¸šåŠ¡

### 5.4 ç¬¬4å±‚ï¼šä¼ è¾“å±‚ (fetch-event-source)

```typescript
// node_modules/@microsoft/fetch-event-source/lib/fetch.js (ç®€åŒ–ç‰ˆæœ¬)

/**
 * fetch-event-sourceæ ¸å¿ƒå®ç°
 * å¢å¼ºå‹SSEå®¢æˆ·ç«¯ï¼Œè§£å†³åŸç”ŸEventSourceå±€é™æ€§
 */
export async function fetchEventSource(
  input: string,
  {
    method = 'GET',
    headers = {},
    body,
    credentials,
    openWhenHidden = false,
    onopen,
    onmessage,
    onclose,
    onerror,
    ...rest
  }: FetchEventSourceInit
): Promise<void> {
  
  // 1. å‘èµ·HTTPè¯·æ±‚
  const response = await fetch(input, {
    method,
    headers: {
      'Accept': 'text/event-stream',
      'Cache-Control': 'no-cache',
      ...headers,
    },
    body,
    credentials,
    ...rest
  });

  // 2. å¤„ç†è¿æ¥å»ºç«‹
  if (onopen) {
    await onopen(response);
  }

  // 3. è¯»å–æµå¼å“åº”
  const reader = response.body!.getReader();
  const decoder = new TextDecoder();
  
  try {
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      
      // 4. è§£æSSEæ•°æ®æ ¼å¼
      const chunk = decoder.decode(value, { stream: true });
      const lines = chunk.split('\n');
      
      for (const line of lines) {
        if (line.startsWith('data: ')) {
          const data = line.slice(6);
          if (data === '[DONE]') {
            return;
          }
          
          // 5. è§¦å‘æ¶ˆæ¯å›è°ƒ
          if (onmessage) {
            onmessage({
              data,
              event: 'message',
              id: '',
              retry: 0
            } as EventSourceMessage);
          }
        }
      }
    }
  } catch (error) {
    // 6. é”™è¯¯å¤„ç†å’Œè‡ªåŠ¨é‡è¿
    if (onerror) {
      onerror(error as Error);
    }
    
    // è‡ªåŠ¨é‡è¿é€»è¾‘ï¼ˆç®€åŒ–ï¼‰
    setTimeout(() => {
      fetchEventSource(input, arguments[1]);
    }, 1000);
  } finally {
    // 7. æ¸…ç†èµ„æº
    reader.releaseLock();
    if (onclose) {
      onclose();
    }
  }
}
```

**ç¬¬4å±‚çš„æ ¸å¿ƒèŒè´£ï¼š**
- **HTTPæµå¼åè®®å¤„ç†**ï¼šåŸºäºFetch APIå®ç°æ ‡å‡†SSEåè®®
- **å¢å¼ºçš„é…ç½®èƒ½åŠ›**ï¼šæ”¯æŒPOSTè¯·æ±‚ã€è‡ªå®šä¹‰è¯·æ±‚å¤´å’Œè¯·æ±‚ä½“
- **è‡ªåŠ¨é‡è¿æœºåˆ¶**ï¼šç½‘ç»œä¸­æ–­æ—¶è‡ªåŠ¨é‡å»ºè¿æ¥ï¼Œæä¾›ç¨³å®šé€šä¿¡ä¿éšœ  
- **æµå¼æ•°æ®è§£æ**ï¼šé«˜æ•ˆå¤„ç†æœåŠ¡ç«¯æ¨é€çš„è¿ç»­æ•°æ®æµ
- **è·¨æµè§ˆå™¨å…¼å®¹**ï¼šæä¾›ä¸€è‡´çš„SSEèƒ½åŠ›ï¼Œæ— éœ€æ‹…å¿ƒæµè§ˆå™¨å·®å¼‚

## å…­ã€å°ç»“

æœ¬èŠ‚ä»¥JoyAgent-JDGenieé¡¹ç›®çš„å‰ç«¯å®ç°ä¸ºå®é™…æ¡ˆä¾‹ï¼Œæ·±å…¥å‰–æäº†åŸºäºfetch-event-sourceçš„æµå¼é€šä¿¡å®¢æˆ·ç«¯å®Œæ•´æ¶æ„ã€‚æ ¸å¿ƒè¦ç‚¹å¦‚ä¸‹ï¼š

**å…³é”®æŠ€æœ¯é€‰å‹**ï¼š

æœ¬æ¡ˆä¾‹æ¶‰åŠçš„å…³é”®æŠ€æœ¯å¯åˆ†ä¸ºä¸‰ç±»ï¼š

| ç±»å‹ | æŠ€æœ¯ | å®šä½ | æ ¸å¿ƒä½œç”¨ |
|------|------|------|----------|
| **æ ¸å¿ƒåº“** | @microsoft/fetch-event-source | å¢å¼ºå‹SSEå®¢æˆ·ç«¯ | è§£å†³åŸç”ŸEventSourceå±€é™ï¼Œæ”¯æŒPOSTè¯·æ±‚å’Œè‡ªå®šä¹‰é…ç½® |
| **å¼€å‘æ¡†æ¶** | React + TypeScript | å‰ç«¯åº”ç”¨æ¡†æ¶ | æä¾›ç»„ä»¶åŒ–å¼€å‘å’Œç±»å‹å®‰å…¨ä¿éšœ |
| **æ€§èƒ½ä¼˜åŒ–** | requestAnimationFrame | æµè§ˆå™¨API | å®ç°é«˜æ€§èƒ½çš„æ‰¹å¤„ç†æ¸²æŸ“å’Œ60fpsæµç•…ä½“éªŒ |
| **ç”¨æˆ·ä½“éªŒ** | TypeWriteræœºåˆ¶ | è‡ªç ”ç»„ä»¶ | æä¾›æ‰“å­—æœºçš„å†…å®¹å±•ç¤ºæ•ˆæœ |

å…¶ä¸­ï¼Œ**fetch-event-sourceæ˜¯æ•´ä¸ªæ¶æ„çš„æ ¸å¿ƒåŸºç¡€**â€”â€”å®ƒçªç ´äº†æµè§ˆå™¨åŸç”ŸEventSourceçš„é™åˆ¶ï¼Œä¸ºAIåº”ç”¨åœºæ™¯æä¾›äº†æ›´å¼ºå¤§çš„æµå¼é€šä¿¡èƒ½åŠ›ã€‚é€šè¿‡æ”¯æŒPOSTè¯·æ±‚ã€è‡ªå®šä¹‰è¯·æ±‚å¤´å’Œå®Œå–„çš„é”™è¯¯å¤„ç†ï¼Œå®ƒæˆä¸ºäº†è¿æ¥å‰åç«¯çš„å¯é æ¡¥æ¢ã€‚

**å››å±‚æ¶æ„è®¾è®¡**ï¼š
- **ç¬¬1å±‚ï¼ˆä¸šåŠ¡å±‚ï¼‰**ï¼šè´Ÿè´£ç”¨æˆ·äº¤äº’ç®¡ç†å’ŒReactç»„ä»¶é›†æˆï¼Œæä¾›æµç•…çš„ç”¨æˆ·ä½“éªŒ
- **ç¬¬2å±‚ï¼ˆæ¶ˆæ¯å¤„ç†å±‚ï¼‰**ï¼šå®ç°æ™ºèƒ½æ¶ˆæ¯åˆ†å‘å’Œå¢é‡æ•°æ®åˆå¹¶ï¼Œå¤„ç†å¤æ‚çš„AIå¯¹è¯çŠ¶æ€
- **ç¬¬3å±‚ï¼ˆå°è£…å±‚ï¼‰**ï¼šæä¾›ç»Ÿä¸€çš„SSEæ¥å£å°è£…ï¼Œç®€åŒ–ä¸Šå±‚è°ƒç”¨å¤æ‚åº¦
- **ç¬¬4å±‚ï¼ˆä¼ è¾“å±‚ï¼‰**ï¼šåŸºäºfetch-event-sourceå®ç°å¯é çš„HTTPæµå¼ä¼ è¾“

**æµå¼æ•°æ®å¤„ç†**ï¼šæ¶ˆæ¯è‡ªåº•å±‚å‘ä¸Šé€å±‚å¤„ç†å’Œè½¬æ¢ï¼Œæ¯ä¸€å±‚éƒ½æ‰¿æ‹…ç‰¹å®šçš„èŒè´£ã€‚ä»åŸå§‹SSEäº‹ä»¶æµåˆ°æœ€ç»ˆçš„UIçŠ¶æ€æ›´æ–°ï¼Œæ•´ä¸ªé“¾è·¯å®ç°äº†**ä½å»¶è¿Ÿã€é«˜å¯é ã€ç±»å‹å®‰å…¨**çš„æ•°æ®ä¼ é€’ï¼Œä¸ºç”¨æˆ·æä¾›åª²ç¾ChatGPTçš„æµç•…å¯¹è¯ä½“éªŒã€‚

è¿™ç§åˆ†å±‚æ¶æ„çš„ä¼˜åŠ¿åœ¨äºï¼š**èŒè´£æ¸…æ™°ã€æ˜“äºæ‰©å±•ã€ä¾¿äºç»´æŠ¤**ã€‚å½“éœ€è¦åˆ‡æ¢æœåŠ¡ç«¯æ¥å£æ—¶åªéœ€ä¿®æ”¹å°è£…å±‚é…ç½®ï¼Œå½“éœ€è¦å¢å¼ºç”¨æˆ·ä½“éªŒæ—¶åªéœ€æ‰©å±•ä¸šåŠ¡å±‚ç»„ä»¶ï¼Œä½“ç°äº†è‰¯å¥½çš„å‰ç«¯å·¥ç¨‹åŒ–è®¾è®¡æ€æƒ³ã€‚

---